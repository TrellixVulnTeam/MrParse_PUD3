<!DOCTYPE html>
<!--
data attribute creates object that is bound to this

computed - computed property but with caching
method - computed property - invoked each time

v-model - links inputs to vue js data


https://codepen.io/pespantelis/pen/ojwgPB
https://www.raymondcamden.com/2018/02/08/building-table-sorting-and-pagination-in-vuejs
-->

<html>

<head>
  <title>My first Vue app</title>
  <!-- <script src="https://unpkg.com/vue"></script> -->
  <script src="vue.js"></script>
  <script src="lodash.min.js"></script>
  <script type="text/javascript" src="homologs.js"></script>

  <!-- load the prototype library from google -->
  <script type="text/javascript" src="http://www.google.com/jsapi"></script>
  <script type="text/javascript">
    google.load("prototype", "1.7");
  </script>

  <!-- the domain graphics library -->
  <script type="text/javascript" src="pfam/static/javascripts/domain_graphics.js"></script>

  <!-- in order to standardize the look of text, and in order to make it work at
       all in older browsers (and IE), we need the canvas text library. And, in turn,
       that library uses a font description in a separate javascript file -->
  <!-->
  <script type="text/javascript" src="pfam/static/javascripts/canvas.text.js?dontUseMoz=true&amp;reimplement=true"></script>
  </!-->
  <script type="text/javascript" src="pfam/static/javascripts/canvas.text.js?dontUseMoz=true&amp;reimplement=true"></script>
  <script type="text/javascript" src="pfam/static/javascripts/faces/optimer-bold-normal.js"></script>

  <!-- we use the (non-free) prototip2 library to add tooltips. It's not free, but
       nearly. The domain graphics code should cope if it's not loaded, so you
       could just omit the prototip load -->
  <script type="text/javascript" src="pfam/shared/javascripts/prototip.js"></script>
  <script type="text/javascript" src="pfam/shared/javascripts/styles.js"></script>

  <!-- jmht -->
  <script type="text/javascript" src="data.js"></script>

  <!-- stylesheets. We only really need the rules that are specific to the tooltips -->
  <link rel="stylesheet" href="pfam/static/css/pfam.css" type="text/css" />
  <link rel="stylesheet" href="pfam/shared/css/prototip.css" type="text/css" />

  <!-- IE, being IE, needs extra help. In particular we need to add an extra library
       that implements <canvas> using the VML drawing layer in IE. And, so that
       "console.log" calls don't screw everything up, we include the firebug-lite
       script -->
  <!--[if IE]>
    <script type="text/javascript" src="/static/javascripts/excanvas.js"></script>
    <script type="text/javascript" src="http://getfirebug.com/releases/lite/1.2/firebug-lite-compressed.js"></script>
  <![endif]-->


  <style type="text/css">
    .container {
      width: 100%;
      margin: auto;
      /* padding: 10px; */
    }

    .homolog-table {
      width: 45%;
      float: left;
    }

    .pfam-graphics {
      margin-left: 45%;
    }

    #homologs table,
    th,
    td {
      border: 1px solid black;
      padding: 3px;
    }
  </style>
</head>

<body>
  <div id="app">
    <section class="container">
      <homolog-table></homolog-table>
      <pfam-graphics></pfam-graphics>
    </section>
  </div>

  <script>
    // Add pfam render options to homologs
    for (let i = 0; i < homologs.length; i++) {
      for (let j = 0; j < pfam_json.regions.length; j++) {
        if (homologs[i].name == pfam_json.regions[j].regions[0].text) {
          // console.log("MATCHED "+homologs[i].name + " " + pfam_json.regions[j].regions[0].text);
          homologs[i].pfam_json = pfam_json.regions[j];
        }
      }
    }

    function add_graphic(region, parent) {
      let residueWidth = 1.0;
      let pg = new PfamGraphic();
      pg.setImageParams({
        residueWidth: residueWidth,
        xscale: 1.0,
        yscale: 1.0
      });
      pg.setParent(parent);
      pg.setSequence(region);
      pg.render();
    }

    const EventBus = new Vue();

    Vue.component('pfam-graphics', {
      data: function() {
        return {
          pfam_homologs: this.$root.app_homologs,
        }
      },
      created: function() {
        EventBus.$on("sortedData", sortedData => {
          this.pfam_homologs = sortedData;
        })
      },
      template: `
      <div class="pfam-graphics">
        <br/><br/>
        <pfam-region v-for="homolog in pfam_homologs" :key="homolog.name" :region="homolog.pfam_json"/>
      </div>
      `
    });

    Vue.component('pfam-region', {
      props: {
        region: Object
      },
      mounted: function() {
        add_graphic(this.region, this.$refs.cdiv);
      },
      template: '<div :id=this.$vnode.key ref=cdiv></div>'
    });

    Vue.component('homolog-table', {
      data: function() {
        return {
          hhomologs: this.$root.app_homologs,
          columns: ['name', 'domain', 'range', 'eLLG', 'ncopies', 'molecular_weight', 'rmsd', 'seqid'],
          columnTitles: {
            'name': 'Protein Name',
            'domain': 'Number of the domain',
            'range': 'Length of the protein',
            'eLLG': 'Computed Log Likelihood Gain',
            'ncopies': 'Expected number of copies in the ASU',
            'molecular_weight': 'Molecular Weight in Daltons',
            'rmsd': 'RMSD from template',
            'seqid': 'Sequence Identity to template'
          },
          sortKey: 'domain',
          order: 'desc',
        }
      },
      methods: {
        sortBy: function(sortKey) {
          if (this.sortKey == sortKey) {
            if (this.order == 'asc') {
              this.order = 'desc';
            } else {
              this.order = 'asc';
            }
          }
          this.sortKey = sortKey;
          this.hhomologs = _.orderBy(this.hhomologs, this.sortKey, this.order);
          EventBus.$emit("sortedData", this.hhomologs);
          return
        },
        getTitle: function(column) {
          return this.columnTitles[column];
        }
      },
      mounted: function() {
        this.sortBy('domain')
      },
      filters: {
        decimalPlaces: function(value, num=2) {
          return value.toFixed(num)
        }
      },
      template: `
      <div class="homolog-table">
      <table id="homologs">
          <thead>
            <tr>
              <th v-for="column in columns">
                <a href="#" @click="sortBy(column)" v-bind:title="getTitle(column)">
                  {{ column }}
                </a>
              </th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="homolog in hhomologs">
              <td>{{homolog.name}}</td>
              <td>{{homolog.domain}}</td>
              <td>{{homolog.range}}</td>
              <td>{{homolog.eLLG}}</td>
              <td>{{homolog.ncopies}}</td>
              <td>{{homolog.molecular_weight | decimalPlaces}}</td>
              <td>{{homolog.rmsd}}</td>
              <td>{{homolog.seqid}}</td>
            </tr>
          </tbody>
        </table>
        </div>
        `
    })

    new Vue({
      el: '#app',
      data: {
        app_homologs: homologs
      },
    })
  </script>

</body>

</html>
